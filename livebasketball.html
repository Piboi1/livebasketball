<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Court Management</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 20px;
    }

    h1, h2 {
      text-align: center;
    }

    .section {
      margin-bottom: 40px;
    }

    .court-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 16px;
    }

    .court-card {
      background-color: #fff3e6;
      border: 2px solid #e69500;
      border-radius: 10px;
      width: 220px;
      padding: 16px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      transition: transform 0.2s;
    }

    .court-card:hover {
      transform: scale(1.03);
    }

    .court-card h3 {
      margin: 0 0 10px;
      color: #d36b00;
    }

    .timer {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-top: 10px;
    }

    .label {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="section">
    <h1>Active Courts</h1>
    <div id="activeCourts" class="court-container"></div>
  </div>

  <div class="section">
    <h2>Waitlist</h2>
    <div id="waitlistCourts" class="court-container"></div>
  </div>

  <script>
    const SCRIPT_BASE = 'https://script.google.com/macros/s/AKfycbxr-1qIuIAetE0cPN-JL2C1gGVWDFau83QZ1rMz6sHf5hE2IHa-kWCTu26XlfoPw-Gs/exec';

    const ACTIVE_URL = SCRIPT_BASE + '?mode=read';
    const WAITLIST_URL = SCRIPT_BASE + '?mode=waitlist';
    const REMOVE_URL = SCRIPT_BASE + '?mode=remove'; // This must be handled in Apps Script

    function fetchData() {
      fetchActiveCourts();
      fetchWaitlistCourts();
    }

    function fetchActiveCourts() {
      fetch(ACTIVE_URL)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("activeCourts");
          container.innerHTML = "";
          data.forEach(entry => createCourtCard(entry, container, true));
        });
    }

    function fetchWaitlistCourts() {
      fetch(WAITLIST_URL)
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById("waitlistCourts");
          container.innerHTML = "";
          data.forEach(entry => createCourtCard(entry, container, false));
        });
    }

    function createCourtCard(entry, parent, isActive) {
      const card = document.createElement("div");
      card.className = "court-card";

      const startTime = new Date(entry.timestamp);

      card.innerHTML = `
        <h3>${entry.courtType} Court</h3>
        <p><span class="label">Skill:</span> ${entry.skillLevel}</p>
        <p><span class="label">Players Needed:</span> ${entry.playersNeeded}</p>
        ${isActive ? `<div class="timer" id="timer-${entry.ticketNumber}">01:00</div>` : ''}
      `;

      parent.appendChild(card);

      if (isActive) {
        startTimer(entry.ticketNumber, startTime);
      }
    }

    function startTimer(ticketNumber, startTime) {
      const duration = 60; // seconds
      const interval = setInterval(() => {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const remaining = Math.max(0, duration - elapsed);
        const mins = String(Math.floor(remaining / 60)).padStart(2, '0');
        const secs = String(remaining % 60).padStart(2, '0');

        const timerEl = document.getElementById(`timer-${ticketNumber}`);
        if (timerEl) {
          timerEl.innerText = `${mins}:${secs}`;
        }

        if (remaining <= 0) {
          clearInterval(interval);
          removeCourt(ticketNumber);
        }
      }, 1000);
    }

    function removeCourt(ticketNumber) {
      fetch(`${SCRIPT_BASE}?mode=remove&ticket=${ticketNumber}`)
        .then(() => {
          // After removal, the Apps Script should auto-promote from waitlist if space allows
          fetchData();
        });
    }

    // Initial load
    fetchData();

    // Optional: Refresh every 5 seconds
    setInterval(fetchData, 5000);
  </script>

</body>
</html>
