<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Live Court Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f2f2f2;
      padding: 20px;
      text-align: center;
    }

    h1 {
      color: #333;
    }

    .court-box {
      border: 3px solid #333;
      border-radius: 12px;
      background: white;
      padding: 20px;
      max-width: 500px;
      margin: 20px auto;
      position: relative;
    }

    .active {
      border-color: green;
      background-color: #d4fcd4;
    }

    .inactive {
      border-color: red;
      background-color: #fcd4d4;
    }

    .timer {
      font-size: 1.2em;
      font-weight: bold;
      background-color: #333;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      position: absolute;
      top: 10px;
      right: 10px;
    }

    .waitlist-box {
      border: 2px dashed #666;
      background: #fff7cc;
      border-radius: 10px;
      padding: 15px;
      max-width: 600px;
      margin: 40px auto;
    }

    .waitlist-box h2 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Live Court Status</h1>
  <div id="courtStatus"></div>
  <div id="waitlistSection"></div>

  <script>
    const FETCH_URL = "https://script.google.com/macros/s/AKfycbxr-1qIuIAetE0cPN-JL2C1gGVWDFau83QZ1rMz6sHf5hE2IHa-kWCTu26XlfoPw-Gs/exec?mode=read";
    const SESSION_DURATION_MINUTES = 1;

    let courtData = {};
    let waitlistData = {};

    function getRemainingSeconds(timestamp) {
      const start = new Date(timestamp);
      const now = new Date();
      const end = new Date(start.getTime() + SESSION_DURATION_MINUTES * 60000);
      return Math.max(0, Math.floor((end - now) / 1000));
    }

    function formatTime(seconds) {
      const min = String(Math.floor(seconds / 60)).padStart(2, '0');
      const sec = String(seconds % 60).padStart(2, '0');
      return `${min}:${sec}`;
    }

    function renderCourts() {
      const container = document.getElementById("courtStatus");
      container.innerHTML = "";

      const courts = Object.entries(courtData);
      courts.forEach(([courtName, team]) => {
        const secondsLeft = getRemainingSeconds(team.timestamp);
        const isActive = secondsLeft > 0;

        const box = document.createElement("div");
        box.className = `court-box ${isActive ? "active" : "inactive"}`;

        box.innerHTML = `
          <h2>${courtName}</h2>
          <p><strong>Team #</strong> ${team.ticketNumber}</p>
          <p><strong>Skill:</strong> ${team.skillLevel}</p>
          <p><strong>Players Needed:</strong> ${team.playersNeeded}</p>
          <div class="timer" id="timer-${courtName}">${formatTime(secondsLeft)}</div>
        `;

        container.appendChild(box);
      });
    }

    function renderWaitlist() {
      const container = document.getElementById("waitlistSection");
      container.innerHTML = "";

      const entries = waitlistData;
      if (!entries.length) return;

      const box = document.createElement("div");
      box.className = "waitlist-box";
      box.innerHTML = "<h2>Waitlist</h2>";

      entries.forEach(entry => {
        box.innerHTML += `
          <p><strong>Team #</strong> ${entry.ticketNumber} — ${entry.courtType} — ${entry.skillLevel} — Needs ${entry.playersNeeded} player(s)</p>
        `;
      });

      container.appendChild(box);
    }

    async function fetchData() {
      try {
        const res = await fetch(FETCH_URL);
        const data = await res.json();

        courtData = {};
        waitlistData = [];

        // Court capacity logic
        let fullUsed = 0;
        let halfUsed = 0;

        data.forEach(entry => {
          const court = entry.courtType;
          const remaining = getRemainingSeconds(entry.timestamp);

          if (court === "Full" && fullUsed < 2) {
            fullUsed++;
            courtData[`Full Court ${fullUsed}`] = entry;
          } else if (court === "Half" && halfUsed < 4) {
            halfUsed++;
            courtData[`Half Court ${halfUsed}`] = entry;
          } else {
            waitlistData.push(entry);
          }
        });

        renderCourts();
        renderWaitlist();
      } catch (err) {
        console.error("Error fetching data:", err);
      }
    }

    function updateTimers() {
      for (const [courtName, team] of Object.entries(courtData)) {
        const secondsLeft = getRemainingSeconds(team.timestamp);
        const timerEl = document.getElementById(`timer-${courtName}`);
        if (timerEl) {
          timerEl.innerText = formatTime(secondsLeft);
          timerEl.style.backgroundColor = secondsLeft > 0 ? "#333" : "red";
        }
      }
    }

    fetchData();
    setInterval(fetchData, 15000);  // refresh every 15s
    setInterval(updateTimers, 1000); // smooth timer
  </script>
</body>
</html>
